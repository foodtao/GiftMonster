package com.li5tao.data.collect.alimama;

import java.io.ByteArrayOutputStream;
import java.io.InputStream;
import java.net.URI;
import java.util.List;

import org.apache.http.HttpEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpUriRequest;
import org.apache.http.client.methods.RequestBuilder;
import org.apache.http.cookie.Cookie;
import org.apache.http.impl.client.BasicCookieStore;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;

public class Login {
	
	private String _username = "";
	
	private String _password = "";
	
	private String _passwordEncrypt = "";
	
	public Login(String username, String password,String pwdEncrypt){
		this._username = username;
		this._password = password;
		this._passwordEncrypt = pwdEncrypt;
	}
	
	/*
	 * µÇÂ¼·½·¨
	 * return:·µ»Øtoken
	 */
	public String LoginIn() throws Exception{
		String token = "";
		
		BasicCookieStore cookieStore = new BasicCookieStore();
		CloseableHttpClient httpclient = HttpClients.custom()
				.setDefaultCookieStore(cookieStore)
				.build();
		try{
			HttpGet httpget = new HttpGet("http://www.alimama.com/index.htm");
			CloseableHttpResponse response = httpclient.execute(httpget);
			
			try{
				HttpEntity entity = response.getEntity();
				List<Cookie> cookies = cookieStore.getCookies();
				if(!cookies.isEmpty()){
					for(Cookie cookie : cookies){
						System.out.println(cookie.getName());
						System.out.println(cookie.getValue());
						if(cookie.getName() == "_tb_token_"){
							token = cookie.getValue();
							System.out.println(token);
						}
					}
				}
				
			}finally{
				response.close();
			}
			
			HttpUriRequest login = RequestBuilder.post()
					.setUri(new URI("http://www.alimama.com/member/minilogin_act.htm"))
					.addParameter("_tb_token_",token)
					.addParameter("style", "")
					.addParameter("redirect", "")
					.addParameter("proxy", "http%3A%2F%2Fwww.alimama.com%2Fproxy.htm")
					.addParameter("logname", _username)
					.addParameter("originalLogpasswd", _password)
					.addParameter("logpasswd", _passwordEncrypt)
					.build();
			
			response = httpclient.execute(login);
			try{
				HttpEntity entity = response.getEntity();
				
				InputStream in = entity.getContent();
				ByteArrayOutputStream outStream = new ByteArrayOutputStream();
				byte[] data = new byte[4096];
				int count = -1;
				while((count = in.read(data,0,4096)) != -1){
					outStream.write(data,0,count);
				}
				System.out.println(new String(outStream.toByteArray(),"utf-8"));
				
			}finally{
				response.close();
			}
			
		}finally{
			httpclient.close();
		}
		
		
		return token;
	}
	
	/*
	 * main method
	 */
	public static void main(String[] args){
		try{
			Login login = new Login("","","");
			login.LoginIn();
		}catch(Exception e){
			
		}
	}
}
